<html>

<head>
<meta http-equiv=Content-Type content="text/html; charset=utf-8">
<meta name=Generator content="Microsoft Word 15 (filtered)">
<title>API Services是什麼？</title>
<style>
<!--
 /* Font Definitions */
 @font-face
	{font-family:Wingdings;
	panose-1:5 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:新細明體;
	panose-1:2 2 5 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Cambria Math";
	panose-1:2 4 5 3 5 4 6 3 2 4;}
@font-face
	{font-family:Calibri;
	panose-1:2 15 5 2 2 2 4 3 2 4;}
@font-face
	{font-family:"\@新細明體";
	panose-1:2 1 6 1 0 1 1 1 1 1;}
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{margin:0cm;
	font-size:12.0pt;
	font-family:"Calibri",sans-serif;}
a:link, span.MsoHyperlink
	{color:#0563C1;
	text-decoration:underline;}
p.MsoListParagraph, li.MsoListParagraph, div.MsoListParagraph
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:24.0pt;
	font-size:12.0pt;
	font-family:"Calibri",sans-serif;}
.MsoChpDefault
	{font-family:"Calibri",sans-serif;}
 /* Page Definitions */
 @page WordSection1
	{size:595.3pt 841.9pt;
	margin:72.0pt 90.0pt 72.0pt 90.0pt;
	layout-grid:18.0pt;}
div.WordSection1
	{page:WordSection1;}
 /* List Definitions */
 ol
	{margin-bottom:0cm;}
ul
	{margin-bottom:0cm;}
-->
</style>

</head>

<body lang=ZH-TW link="#0563C1" vlink="#954F72" style='word-wrap:break-word;
text-justify-trim:punctuation'>

<div class=WordSection1 style='layout-grid:18.0pt'>

<p class=MsoNormal><span lang=EN-US style='font-size:24.0pt'>API Services</span><span
style='font-size:24.0pt;font-family:"新細明體",serif'>是什麼？</span></p>

<p class=MsoNormal><span lang=EN-US><img width=595 height=725 id="圖片 1"
src="api.files/image001.png"></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span style='font-family:"新細明體",serif'>上面的灰底小字告訴我們，這是個選項，可開可不開。啟用後可以透過</span><span
lang=EN-US>port 31401</span><span style='font-family:"新細明體",serif'>、</span><span
lang=EN-US>http</span><span style='font-family:"新細明體",serif'>的方式跟區塊鏈互動，並且會消耗大量的磁碟空間。</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>Pi</span><span style='font-family:"新細明體",serif'>節點程式的</span><span
lang=EN-US>API Services</span><span style='font-family:"新細明體",serif'>就是「</span><span
lang=EN-US>Horizon API</span><span style='font-family:"新細明體",serif'>」。</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>Horizon</span><span style='font-family:
"新細明體",serif'>是一個</span><span lang=EN-US>RESTful API</span><span
style='font-family:"新細明體",serif'>，可以讓人們輕鬆地透過</span><span lang=EN-US>http</span><span
style='font-family:"新細明體",serif'>跟</span><span lang=EN-US>Stellar Core</span><span
style='font-family:"新細明體",serif'>溝通，而不必擔心底層細節，也不用懂得</span><span lang=EN-US>Stellar
SDK</span><span style='font-family:"新細明體",serif'>。<span style='background:yellow'>所以如果節點沒有開</span></span><span
lang=EN-US style='background:yellow'>port</span><span style='font-family:"新細明體",serif;
background:yellow'>，啟用</span><span lang=EN-US style='background:yellow'>API
Services</span><span style='font-family:"新細明體",serif;background:yellow'>就沒意義，因為外部連不進來。</span><span
style='font-family:"新細明體",serif'>除非你自己會寫程式，要在本機提交交易。</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span style='font-family:"新細明體",serif'>它可以讓你做到：</span></p>

<p class=MsoListParagraph style='margin-left:24.0pt;text-indent:-24.0pt'><span
lang=EN-US style='font-family:Wingdings'>l<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span style='font-family:"新細明體",serif'>向網路提交交易</span></p>

<p class=MsoListParagraph style='margin-left:24.0pt;text-indent:-24.0pt'><span
lang=EN-US style='font-family:Wingdings'>l<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span style='font-family:"新細明體",serif'>讀取有關區塊當前狀態的訊息（如帳戶餘額）</span></p>

<p class=MsoListParagraph style='margin-left:24.0pt;text-indent:-24.0pt'><span
lang=EN-US style='font-family:Wingdings'>l<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span style='font-family:"新細明體",serif'>探索歷史資料（例如賬戶之前提交給網路的交易）</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoListParagraph style='margin-left:24.0pt;text-indent:-24.0pt'><span
lang=EN-US style='font-family:Wingdings'>²<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span></span><span style='font-family:"新細明體",serif'>為什麼需要</span><span
lang=EN-US>Horizon</span><span style='font-family:"新細明體",serif'>呢？</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>Stellar Core</span><span style='font-family:
"新細明體",serif'>著重的是驗證交易並維護「當前」區塊的狀況，並未針對查詢最佳化。它使用的</span><span lang=EN-US>XDR</span><span
style='font-family:"新細明體",serif'>檔難以閱讀，且缺乏有用的索引，因此很難查找。未優化的查詢實際上會減慢節點的速度，在最壞的情況下，這可能會導致它失去共識。</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>Horizon</span><span style='font-family:
"新細明體",serif'>旨在允許開發人員提交交易並有效地使用網路資料。它從</span><span lang=EN-US>Stellar Core</span><span
style='font-family:"新細明體",serif'>獲取</span><span lang=EN-US>XDR</span><span
style='font-family:"新細明體",serif'>資料並將其解碼為更容易使用的</span><span lang=EN-US>JSON</span><span
style='font-family:"新細明體",serif'>，讓閱讀區塊的當前狀態或探索歷史資料變得容易。同時讓</span><span
lang=EN-US>Stellar Core</span><span style='font-family:"新細明體",serif'>可以專注於共識的工作。</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoListParagraph style='margin-left:24.0pt;text-indent:-24.0pt'><span
lang=EN-US style='font-family:Wingdings'>²<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span></span><span style='font-family:"新細明體",serif'>為什麼執行</span><span
lang=EN-US>Horizon</span><span style='font-family:"新細明體",serif'>會消耗大量的磁碟空間？</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>Horizon</span><span style='font-family:
"新細明體",serif'>從</span><span lang=EN-US>Stellar Core</span><span
style='font-family:"新細明體",serif'>讀取資料，將其處理成「</span><span lang=EN-US>transaction
metadata</span><span style='font-family:"新細明體",serif'>」</span><span lang=EN-US>(</span><span
style='font-family:"新細明體",serif'>例如</span><span lang=EN-US>balance history</span><span
style='font-family:"新細明體",serif'>、</span><span lang=EN-US>account effects</span><span
style='font-family:"新細明體",serif'>等資料依照時間序列處理</span><span lang=EN-US>)</span><span
style='font-family:"新細明體",serif'>，然後儲存在</span><span lang=EN-US>Horizon DB(</span><span
style='font-family:"新細明體",serif'>使用</span><span lang=EN-US>PostgreSQL</span><span
style='font-family:"新細明體",serif'>資料庫</span><span lang=EN-US>)</span><span
style='font-family:"新細明體",serif'>，所以會消耗磁碟空間。</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span style='font-family:"新細明體",serif'>隨著時間的推移，歷史紀錄不斷累積，從而增加資料庫使用的存儲空間。可以使用</span><span
lang=EN-US>--history-retention-count flag</span><span style='font-family:"新細明體",serif'>或</span><span
lang=EN-US>HISTORY_RETENTION_COUNT</span><span style='font-family:"新細明體",serif'>環境變數來設定希望保留的區塊數量，但是</span><span
lang=EN-US>Pi</span><span style='font-family:"新細明體",serif'>沒有設定，所以會無限增長。</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span style='font-family:"新細明體",serif'>結論，到底要不要執行</span><span
lang=EN-US>Horizon</span><span style='font-family:"新細明體",serif'>？我的建議是看個人，如果你的節點有開</span><span
lang=EN-US>port</span><span style='font-family:"新細明體",serif'>、磁碟空間足夠，想對整個</span><span
lang=EN-US>Pi Network</span><span style='font-family:"新細明體",serif'>多盡一份力，那就執行吧。</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span style='font-family:"新細明體",serif'>附上老尼的回答：</span></p>

<p class=MsoNormal><span lang=EN-US><img width=803 height=616 id="圖片 2"
src="api.files/image002.jpg"></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span style='font-size:24.0pt;font-family:"新細明體",serif'>為什麼有人說追區塊時要關閉</span><span
lang=EN-US style='font-size:24.0pt'>API</span><span style='font-size:24.0pt;
font-family:"新細明體",serif'>，同步後再打開？</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span style='font-family:"新細明體",serif'>網路上流傳一個說法，當本地區塊落後網路很多時，只要將</span><span
lang=EN-US>API Services</span><span style='font-family:"新細明體",serif'>關閉，就能趕上同步了，之後再將</span><span
lang=EN-US>API Services</span><span style='font-family:"新細明體",serif'>打開。具體原因並沒有人說明，只是大家嘗試出來的方法，然後口耳相傳。我試著來分析一下原因。</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span style='font-family:"新細明體",serif'>先講一個重點，</span><span
lang=EN-US>SCP</span><span style='font-family:"新細明體",serif'>的點對點</span><span
lang=EN-US>(peer-to-peer)</span><span style='font-family:"新細明體",serif'>協議中，節點之間交換的只有「當前」區塊的</span><span
lang=EN-US>XDR</span><span style='font-family:"新細明體",serif'>資料，歷史資料一律都是由</span><span
lang=EN-US>History Archives</span><span style='font-family:"新細明體",serif'>下載</span><span
lang=EN-US>(</span><span style='font-family:"新細明體",serif'>此行為稱</span><span
lang=EN-US>Catchup)</span><span style='font-family:"新細明體",serif'>，下載後會先驗證其安全性，然後才寫入</span><span
lang=EN-US>Core DB</span><span style='font-family:"新細明體",serif'>及本地磁碟上的</span><span
lang=EN-US>XDR</span><span style='font-family:"新細明體",serif'>檔中</span><span
lang=EN-US>(</span><span style='font-family:"新細明體",serif'>稱為</span><span
lang=EN-US>Buckets)</span><span style='font-family:"新細明體",serif'>。</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span style='font-family:"新細明體",serif'>在目前的測試網中，大家的</span><span
lang=EN-US>History Archives</span><span style='font-family:"新細明體",serif'>都設定為</span><span
lang=EN-US>history.testnet.minepi.com</span><span style='font-family:"新細明體",serif'>這台機器，其負載可想而知。</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span style='font-family:"新細明體",serif'>觀察節點的</span><span
lang=EN-US>stellar-core-stdout.log</span><span style='font-family:"新細明體",serif'>，可發現一開始可能是某些原因</span><span
lang=EN-US>(CPU</span><span style='font-family:"新細明體",serif'>、</span><span
lang=EN-US>I/O</span><span style='font-family:"新細明體",serif'>、網路？</span><span
lang=EN-US>)</span><span style='font-family:"新細明體",serif'>造成共識失敗、有一些</span><span
lang=EN-US>Perf WARNING</span><span style='font-family:"新細明體",serif'>、</span><span
lang=EN-US>Out of sync</span><span style='font-family:"新細明體",serif'>，然後開始了</span><span
lang=EN-US>Catchup</span><span style='font-family:"新細明體",serif'>行為，以期望能趕上區塊</span><span
lang=EN-US>(Catchup</span><span style='font-family:"新細明體",serif'>詳細的過程請參考</span>
<span lang=EN-US><a href="https://yuanrui919.github.io/catchup">https://yuanrui919.github.io/catchup</a>
)</span><span style='font-family:"新細明體",serif'>。</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span style='font-family:"新細明體",serif'>可是</span><span
lang=EN-US>History Archives</span><span style='font-family:"新細明體",serif'>下載緩慢，下載完還要處理它，</span><span
lang=EN-US>Horizon</span><span style='font-family:"新細明體",serif'>又在一旁湊熱鬧，讓原本效能就不好的情況雪上加霜，最後區塊的落差越來越大，一直趕不上。</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span style='font-family:"新細明體",serif'>停掉</span><span
lang=EN-US>Horizon</span><span style='font-family:"新細明體",serif'>之後，</span><span
lang=EN-US>CPU</span><span style='font-family:"新細明體",serif'>跟</span><span
lang=EN-US>I/O</span><span style='font-family:"新細明體",serif'>都輕鬆多了，就能逐漸趕上區塊。所以問題可能是在於機器的效能。</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span style='font-family:"新細明體",serif'>除了網路延遲是不可控因素以外</span><span
lang=EN-US>(</span><span style='font-family:"新細明體",serif'>請參考</span> <span
lang=EN-US><a href="https://yuanrui919.github.io/latency">https://yuanrui919.github.io/latency</a>
)</span><span style='font-family:"新細明體",serif'>，如果真的是</span><span lang=EN-US>CPU</span><span
style='font-family:"新細明體",serif'>或</span><span lang=EN-US>I/O</span><span
style='font-family:"新細明體",serif'>效能太差，建議要升級設備，否則等開放式主網之後的交易量更多，肯定是無法負荷。</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span style='font-family:"新細明體",serif'>另外一提，</span><span
lang=EN-US>Horizon</span><span style='font-family:"新細明體",serif'>啟動時，並不是將</span><span
lang=EN-US>Core DB</span><span style='font-family:"新細明體",serif'>全部的資料都抓過來。</span><span
lang=EN-US>Stellar Core</span><span style='font-family:"新細明體",serif'>有一個</span><span
lang=EN-US>cursor</span><span style='font-family:"新細明體",serif'>用來保留資料不會被</span><span
lang=EN-US>Stellar Core garbage collection</span><span style='font-family:"新細明體",serif'>清除，如果</span><span
lang=EN-US>Horizon</span><span style='font-family:"新細明體",serif'>只是短暫停止再啟動停，就會從</span><span
lang=EN-US>cursor</span><span style='font-family:"新細明體",serif'>的地方開始讀；但如果停太久了，</span><span
lang=EN-US>cursor</span><span style='font-family:"新細明體",serif'>資料早已過期，或是第一次啟動</span><span
lang=EN-US>Horizon</span><span style='font-family:"新細明體",serif'>，就會從目前的區塊開始。</span></p>

<div style='border:none;border-bottom:solid windowtext 1.0pt;padding:0cm 0cm 1.0pt 0cm'>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

</div>

<p class=MsoNormal align=center style='text-align:center'><span lang=EN-US><a
href="https://yuanrui919.github.io/"><span lang=EN-US style='font-family:"新細明體",serif'><span
lang=EN-US>回首頁</span></span></a></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

</div>

</body>

</html>
